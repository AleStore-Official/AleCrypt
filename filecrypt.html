<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>AleCrypt â€“ Cripta</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <script>
    // ğŸ” Protezione gate
    if (sessionStorage.getItem("alecrypt-accesso") !== "ok") {
      location.href = "gate.html";
    }
  </script>

  <button id="themeToggle" title="Tema">ğŸŒ™</button>
  <div class="centered">
    <h2>âœï¸ Cripta un messaggio</h2>
    <textarea id="textInput" placeholder="Scrivi il tuo messaggio..."></textarea>

    <select id="expiry">
      <option value="0">â™¾ï¸ Mai</option>
      <option value="3600000">1 ora</option>
      <option value="86400000">24 ore</option>
      <option value="604800000">7 giorni</option>
      <option value="2592000000">30 giorni</option>
    </select>

    <p id="expiryInfo">â±ï¸ Scadenza stimata: nessuna</p>

    <button onclick="encryptAndSave()">ğŸ” Cripta</button>

    <pre id="outputBox">ğŸ“¦ La tua chiave comparirÃ  qui...</pre>
    <button id="copyBtn" style="display:none;">ğŸ“‹ Copia chiave</button>

    <pre id="originalBox" style="display:none;">ğŸ“ Messaggio originale:</pre>
    <button id="copyMsgBtn" style="display:none;">ğŸ“‹ Copia messaggio</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabase = createClient(
      'https://anfgsrtcbpvaihrtqnlv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFuZmdzcnRjYnB2YWlocnRxbmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NTI1NTIsImV4cCI6MjA2NzMyODU1Mn0.4tNAZ0RXc-zFFCNT8Wm6Bdo3TkhLc0Up90KxAdUhYss'
    );

    const expirySelect = document.getElementById("expiry")
    const expiryInfo = document.getElementById("expiryInfo")
    expirySelect.addEventListener("change", () => {
      const durata = parseInt(expirySelect.value)
      expiryInfo.textContent = durata === 0
        ? "â±ï¸ Scadenza stimata: nessuna"
        : "â±ï¸ Scadenza stimata: " + new Date(Date.now() + durata).toLocaleString()
    })
    expirySelect.dispatchEvent(new Event("change"))

    const toggle = document.getElementById("themeToggle")
    if (localStorage.getItem("alecrypt-theme") === "dark") {
      document.body.classList.add("dark")
      toggle.innerText = "â˜€ï¸"
    }
    toggle.addEventListener("click", () => {
      document.body.classList.toggle("dark")
      const t = document.body.classList.contains("dark") ? "dark" : "light"
      localStorage.setItem("alecrypt-theme", t)
      toggle.innerText = t === "dark" ? "â˜€ï¸" : "ğŸŒ™"
    })

    function generateCustomKey(length = 64) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()-_=+[]{}|;:,.<>?'
      let result = ''
      for (let i = 0; i < length; i++) {
        result += chars[Math.floor(Math.random() * chars.length)]
      }
      return result
    }

    async function encryptAndSave() {
      const msg = document.getElementById("textInput").value.trim()
      const output = document.getElementById("outputBox")
      const copia = document.getElementById("copyBtn")
      const originalBox = document.getElementById("originalBox")
      const copyMsgBtn = document.getElementById("copyMsgBtn")

      if (!msg) {
        alert("âš ï¸ Inserisci un messaggio prima di criptare.")
        return
      }

      const durata = parseInt(expirySelect.value)
      const key = "ğŸ”‘" + generateCustomKey()
      const cipher = CryptoJS.AES.encrypt(msg, key).toString()
      const hash = CryptoJS.SHA256(cipher).toString()
      const expires = durata > 0 ? Date.now() + durata : null
      const timestamp = new Date().toISOString()

      const payload = { cipher, hash, expires, timestamp }
      localStorage.setItem(key, JSON.stringify(payload))

      const userId = localStorage.getItem("userId") || "debug-user"
      await supabase.from("messaggi").upsert({
        id: hash.substring(0, 24),
        user_id: userId,
        contenuto: cipher,
        data: timestamp,
        dispositivo: navigator.userAgent,
        scadenza: expires
      })

      output.textContent = "âœ… Chiave di decriptazione:\n\n" + key
      copia.style.display = "inline-block"
      copia.innerText = "ğŸ“‹ Copia chiave"
      copia.onclick = () => {
        navigator.clipboard.writeText(key).then(() => {
          copia.innerText = "âœ… Copiata!"
          setTimeout(() => (copia.innerText = "ğŸ“‹ Copia chiave"), 2000)
        })
      }

      originalBox.style.display = "block"
      originalBox.textContent = "ğŸ“ Messaggio originale:\n\n" + msg
      copyMsgBtn.style.display = "inline-block"
      copyMsgBtn.innerText = "ğŸ“‹ Copia messaggio"
      copyMsgBtn.onclick = () => {
        navigator.clipboard.writeText(msg).then(() => {
          copyMsgBtn.innerText = "âœ… Copiato!"
          setTimeout(() => (copyMsgBtn.innerText = "ğŸ“‹ Copia messaggio"), 2000)
        })
      }
    }

    window.encryptAndSave = encryptAndSave
  </script>
</body>
</html>