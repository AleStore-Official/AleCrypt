<!DOCTYPE html
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AleCrypt ‚Äì Encrypt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <button id="themeToggle" title="Toggle theme">üåô</button>

  <div class="centered">
    <h2>‚úçÔ∏è Encrypt a Message</h2>
    <textarea id="textInput" placeholder="Write your message..."></textarea>

    <select id="expiry">
      <option value="600000">10 minutes</option>
      <option value="1800000">30 minutes</option>
      <option value="3600000">1 hour</option>
      <option value="21600000">6 hours</option>
      <option value="43200000">12 hours</option>
      <option value="86400000">1 day</option>
      <option value="259200000">3 days</option>
      <option value="604800000">7 days</option>
      <option value="864000000">10 days</option>
    </select>

    <p id="expiryInfo">‚è±Ô∏è Estimated expiry: none</p>

    <button onclick="encryptAndSave()">üîê Encrypt</button>

    <pre id="outputBox">üì¶ Your decryption key will appear here...</pre>
    <button id="shareBtn" style="display:none;">üîó Share</button>
  </div>

  <div class="signature">
    <p>Created by <strong>AleStore-Official</strong></p>
  </div>

  <script src="script.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const supabase = createClient(
      "https://hsyyrcbibohwvbuwxwok.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzeXlyY2JpYm9od3ZidXd4d29rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjE0MDcsImV4cCI6MjA3NjYzNzQwN30.2KsFsGYjwf_cA7Z9oglVthiaE1_jWYuQ6HMMm5UXsyo"
    );

    function generateCustomKey(length = 64) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()-_=+[]{}|;:,.<>?";
      let result = "";
      for (let i = 0; i < length; i++) {
        result += chars[Math.floor(Math.random() * chars.length)];
      }
      return result;
    }

    async function encryptAndSave() {
      const msg = document.getElementById("textInput").value.trim();
      const output = document.getElementById("outputBox");
      const shareBtn = document.getElementById("shareBtn");

      if (!msg) {
        alert("‚ö†Ô∏è Please enter a message before encrypting.");
        return;
      }

      const duration = parseInt(document.getElementById("expiry").value);
      const key = "üîë" + generateCustomKey();
      const cipher = CryptoJS.AES.encrypt(msg, key).toString();
      const expires = Date.now() + duration;
      const timestamp = new Date().toISOString();

      const { error } = await supabase
        .from("encrypted_messages")
        .insert([{ key, cipher, expires, timestamp }]);

      if (error) {
        alert("‚ùå Error saving message: " + error.message);
        return;
      }

      output.textContent = "‚úÖ Decryption key:\n\n" + key;

      shareBtn.style.display = "inline-block";
      shareBtn.innerText = "üîó Share";
      shareBtn.onclick = async () => {
        const shareText = 
`üîê Hai ricevuto un messaggio cifrato con AleCrypt!

Per leggerlo ti serve questa chiave di decrittazione:
üëâ ${key}

Apri il sito ufficiale AleCrypt per decifrare il contenuto:
üåê https://alestore-official.github.io/AleCrypt

‚è≥ Ricorda: la chiave scade secondo il tempo impostato.`;

        if (navigator.share) {
          try {
            await navigator.share({
              title: "AleCrypt Decryption Key",
              text: shareText
            });
          } catch (err) {
            alert("‚ùå Sharing failed: " + err);
          }
        } else {
          alert("‚ö†Ô∏è Sharing not supported on this browser.");
        }
      };
    }

    window.encryptAndSave = encryptAndSave;
  </script>
  <script>
    const expirySelect = document.getElementById("expiry");
    const expiryInfo = document.getElementById("expiryInfo");
    expirySelect.addEventListener("change", () => {
      const duration = parseInt(expirySelect.value);
      expiryInfo.textContent = "‚è±Ô∏è Estimated expiry: " + new Date(Date.now() + duration).toLocaleString();
    });
    expirySelect.dispatchEvent(new Event("change"));

    const toggle = document.getElementById("themeToggle");
    const currentTheme = localStorage.getItem("alestore-theme");
    if (currentTheme === "dark") {
      document.body.classList.add("dark");
      toggle.textContent = "‚òÄÔ∏è";
    }
    toggle.onclick = () => {
      document.body.classList.toggle("dark");
      const theme = document.body.classList.contains("dark") ? "dark" : "light";
      localStorage.setItem("alestore-theme", theme);
      toggle.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
    };
  </script>
  <script src="https://alestore-official.github.io/AleCAPTCHA/control.js"></script>
  <script type="module">
    import { blockIfUnauthorized } from "https://alestore-official.github.io/AleRegister/access.js";
    blockIfUnauthorized();
  </script>
</body>
</html>