<!-- gate.html -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>AleCrypt ‚Äì Verifica Umana</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    #puzzle {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-template-rows: repeat(3, 100px);
      gap: 2px;
      margin: auto;
      margin-top: 2em;
    }

    .tile {
      width: 100px; height: 100px;
      background-image: url("puzzle.jpg");
      background-size: 300px 300px;
      border: 1px solid #aaa;
      transform-origin: center;
      transition: transform 0.2s ease;
      cursor: pointer;
    }

    body.dark .tile { border-color: #555; }

    #timer, #status {
      margin-top: 1em;
      font-weight: bold;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <button id="themeToggle" title="Tema">üåô</button>
  <div class="centered">
    <h2>üß† Verifica Umana ‚Äì Puzzle AleCrypt</h2>
    <p>Clicca ogni pezzo per ruotarlo e ricreare l‚Äôimmagine corretta</p>
    <div id="puzzle"></div>
    <button onclick="verifica()">‚úÖ Verifica</button>
    <p id="timer">‚è±Ô∏è Tempo rimanente: 30s</p>
    <p id="status">Completa il puzzle prima che il tempo scada</p>
  </div>

  <script>
    const toggle = document.getElementById("themeToggle");
    if (localStorage.getItem("alecrypt-theme") === "dark") {
      document.body.classList.add("dark");
      toggle.textContent = "‚òÄÔ∏è";
    }
    toggle.onclick = () => {
      document.body.classList.toggle("dark");
      const tema = document.body.classList.contains("dark") ? "dark" : "light";
      localStorage.setItem("alecrypt-theme", tema);
      toggle.textContent = tema === "dark" ? "‚òÄÔ∏è" : "üåô";
    };

    const puzzle = document.getElementById("puzzle");
    const rotazioni = {};
    let countdown = 30;
    let timer;
    let blocco = false;

    function coords(i) {
      return { x: -(i % 3) * 100, y: -Math.floor(i / 3) * 100 };
    }

    function creaPuzzle() {
      puzzle.innerHTML = "";
      for (let i = 0; i < 9; i++) {
        const div = document.createElement("div");
        div.className = "tile";
        div.dataset.index = i;
        const pos = coords(i);
        div.style.backgroundPosition = `${pos.x}px ${pos.y}px`;

        const rot = [0, 90, 180, 270][Math.floor(Math.random() * 4)];
        div.style.transform = `rotate(${rot}deg)`;
        rotazioni[i] = rot;

        div.onclick = () => {
          if (blocco) return;
          rotazioni[i] = (rotazioni[i] + 90) % 360;
          div.style.transform = `rotate(${rotazioni[i]}deg)`;
        };

        puzzle.appendChild(div);
      }

      countdown = 30;
      aggiornaTimer();
      clearInterval(timer);
      timer = setInterval(() => {
        countdown--;
        aggiornaTimer();
        if (countdown <= 0) {
          clearInterval(timer);
          blocco = true;
          document.querySelector("button[onclick='verifica()']").style.display = "none";
          document.getElementById("status").textContent = "‚ùå Verifica fallita. Accesso bloccato.";
          document.getElementById("timer").textContent = "‚õî Puzzle scaduto.";
        }
      }, 1000);
    }

    function aggiornaTimer() {
      if (!blocco) {
        document.getElementById("timer").textContent = `‚è±Ô∏è Tempo rimanente: ${countdown}s`;
      }
    }

    function verifica() {
      if (blocco) return;
      const allOk = Object.values(rotazioni).every(r => r === 0);
      const status = document.getElementById("status");
      if (allOk) {
        status.textContent = "‚úÖ Puzzle risolto! Accesso consentito.";
        sessionStorage.setItem("alecrypt-accesso", "ok");
        clearInterval(timer);
        setTimeout(() => location.href = "register.html", 800);
      } else {
        status.textContent = "‚ùå Alcuni pezzi non sono allineati.";
      }
    }

    creaPuzzle();
  </script>
</body>
</html>